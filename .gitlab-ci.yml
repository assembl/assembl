image: python:2.7

stages:
  - test
  - push_to_master
  - build
  - deploy_to_dev
  - test_on_dev
  - deploy_to_uat
  - deploy_to_prod

cache:
  paths:
    - assembl/static2/node_modules/
    - /usr/local/share/.cache/yarn/v2

# test_frontend:
#   except:
#     - master
#   image: node:8
#   before_script:
#     - export PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
#     - cd assembl/static2
#     - yarn
#   script:
#     - yarn run test
#     - yarn run eslint
#     - yarn run stylelint
#     - yarn run flow --quiet

test_integration_and_ui:
  image: node:8-slim
  before_script:
    - apt-get update -qq
    # install chrome dependencies
    - apt-get install -yq gconf-service libasound2 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget
    # install git
    - apt-get install -yq git
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - git clone https://github.com/bluenove/assembl-tests
    - cd assembl-tests
    - yarn
    # fetch data required for e2e tests
    - scp $UI_TESTS_DATA_PATH data.js
  script:
    # run integration tests
    - yarn jest tests/integration
    # run each ui test one by one
    - yarn runinband || true
    - cd screenshots
    - ls
    - scp test-screenshot.png assembl_user@dev-assembl.bluenove.com:~/pptr/
    - scp test-screenshot2.png assembl_user@dev-assembl.bluenove.com:~/pptr/

  artifacts:
    paths:
      - assembl-tests/screenshots/
  allow_failure: true
